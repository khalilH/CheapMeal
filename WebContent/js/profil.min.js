$(function(){function e(e,t){this.id=e,this.login=t}function t(e,t,i){this.bio=e,this.login=t,this.photo="../images/profil/"+i+".png?"+Date.now()}function i(e,t,i,o,n,l){this.id=e,this.auteur=t,this.titre=i,this.photo="../images/"+o+".png",this.ingredients=n,this.note=l}function o(e,t){this.recettes=e,this.profil=t}function n(){return 0!=p?(g/p).toFixed(2):0}function l(e){return!isNaN(e-0)}function r(n,r){if(0==n.length){var s;return void 0==r.Erreur||0==r.Erreur?s=new o(r.recettes,r.profil):(s=new Object,s.Erreur=r.Erreur),s}if(l(n)&&r.auteur instanceof e){var a=new i(r._id,r.auteur,r.titre,r.photo,r.ingredients,r.note.moyenne);return g+=a.note,p+=1,a}if("auteur"==n){var c;return c=new e(r.idAuteur,r.loginAuteur)}if("profil"==n){var d=new t(r.bio,r.login,r.photo);return d}return r}function s(){var e=d();void 0==e&&(e=getCookie(C_NAME_LOGIN));var t="login="+e;void 0!=getCookie(C_NAME_KEY)&&(t+="&cle="+getCookie(C_NAME_KEY)),$.ajax({url:"profil/afficher",type:"GET",data:t,contentType:"application/x-www-form-urlencoded; charset=utf-8",dataType:"json",success:function(e){var t=JSON.stringify(e);if(console.log(t),console.log(t.erreur),void 0==t.erreur){var i=JSON.parse(t,r);console.log(i),c(i)}else a()},error:function(e,t,i){console.log("Bug"),console.log(e),consol.log("Erreur Ajax Affichage Prix")}})}function a(){$("#leftPanel").html("<div class='alert alert-danger'><h1><strong>Attention !</strong> Vous tentez d'accéder à une page inconnue.</h1></div>")}function c(e){$("#rightPanel").html(e.getHtmlRecettes()),$("#leftPanel").html(e.getHtmlProfilCard())}function d(){var e=window.location.search.substr(1),t=new RegExp(/login=(\w+)/),i=t.exec(e);return void 0!=i?i[1]:void 0}function u(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){$("#profilPicture").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}}var g=0,p=0;if(i.prototype.getIngredientsString=function(){for(var e="",t=0;t<this.ingredients.length;t++)e+=this.ingredients[t].nomIngredient,t!=this.ingredients.length-1&&(e+="; ");return e},i.prototype.getHtml=function(){var e="<div class='col-sm-12'><div class='media well recette' id='"+this.id+"'><div class='media-left media-middle'><img class='media-object img-recette' src='"+this.photo+"' alt='Generic placeholder image'></div><div class='media-body'><h3 class='media-heading'>"+this.titre+"</h3><p> Ingredients : <div class='text-muted'>"+this.getIngredientsString()+"</div></p></div>";return getCookie(C_NAME_LOGIN)==this.auteur.login&&(e+="<div class='media-right media-middle'><button data-id='"+this.id+"' class='btn btn-lg btn-default btn-delete'><span class='glyphicon glyphicon-trash'></span></div>"),e+="</div></div>"},o.prototype.getHtmlRecettes=function(){var e="";getCookie(C_NAME_LOGIN)==this.profil.login&&(e+="<div class='col-sm-12'><button id='addRecette' type='button'class='btn btn-primary form-control mg-bottom-20'><span class='glyphicon glyphicon-plus'></span> Ajouter une recette</button></div>");for(var t=0;t<this.recettes.length;t++)e+=this.recettes[t].getHtml();return 0==this.recettes.length&&(e+="<div class='panel panel-primary mg-top-50'><div class='panel-heading'><span class='glyphicon glyphicon-thumbs-down'></span> Dommage</div><div class='panel-body'>Malheuresement, cet utilisateur n'a jamais posté de recettes.</div></div>"),e},o.prototype.getHtmlProfilCard=function(){var e="<div class='row pad15'><div class='col-sm-12'><h3>"+this.profil.login+"</h3><img class='img-responsive' id='profilPicture'src='"+this.profil.photo+"' alt='Profil Picture'>";return getCookie(C_NAME_LOGIN)==this.profil.login&&(e+="<div><div id='connected' class='arrow-bottom'></div><label class='form-control btn btn-primary btn-file'>Ajouter une image<input id='inputFile' type='file' style='display: none;'></label></div>"),void 0!=this.profil.bio&&(e+="<blockquote>"+this.profil.bio+"</blockquote>"),e+="</div><div class='row '><div class='col-sm-12 white-text mg-top-10'><div class='col-sm-4 no-pad bg-blue'><div class='h4'><span class='glyphicon glyphicon-user'></span> 0 Amis</div></div><div class='col-sm-4 no-pad bg-pink'><div class='h4'><span class='glyphicon glyphicon-star'></span> "+n()+"/5</div></div><div class='col-sm-4 no-pad bg-green'><div class='h4'><span class='glyphicon glyphicon-education'></span> "+p+"</div></div></div></div></div>"},1===(bool=isConnected()))loadNavbarConnected(),console.log("connecte");else{if(-1!==bool)return console.log("Invalide"),void(window.location.href="connexion.html");loadNavbarDisconnected(),console.log("deconnecte")}s(),$("#leftPanel").on("change","#inputFile",function(){event.preventDefault();var e=new FormData,t=this;console.log(this.files[0]),e.append("file",this.files[0]),e.append("cle",getCookie(C_NAME_KEY)),e.append("login",getCookie(C_NAME_LOGIN)),console.log(this.files[0]),jQuery.ajax({url:"profil/uploadImage",data:e,cache:!1,contentType:!1,processData:!1,type:"POST",success:function(e){console.log(e),void 0==e.erreur&&u(t)}})}),$("#leftPanel").on("click","#connected",function(){console.log("connecte"),$("#inputFile").click()}),$("#rightPanel").on("click","#addRecette",function(){console.log("add recette"),window.location.href="autocomplete.html"}),$("#rightPanel").on("click",".recette",function(){console.log("Clique sur recette "+this.id),window.location.href="recette.html?idRecette="+this.id}),$("#rightPanel").on("click",".btn-delete",function(e){console.log($(this).data("id"));var t=$(this).data("id");e.stopPropagation(),$("#myModal").modal("show"),$("#confirmDelete").val(t)}),$("#confirmDelete").on("click",function(e){console.log("Confirm "+this.value);var t=this.value;$("#"+t).fadeOut(300,function(){$(this).remove()}),$.ajax({url:"recette/supprimer",type:"POST",data:"cle="+getCookie(C_NAME_KEY)+"&idRecette="+t,contentType:"application/x-www-form-urlencoded; charset=utf-8",dataType:"json",success:function(e){console.log(JSON.stringify(e)),void 0==e.erreur?($("#"+t).fadeOut(300,function(){$(this).remove()}),$("#myModal").modal("hide")):40==obj.erreur?(alert("Votre session a expiré"),deconnexion()):alert("Erreur: "+obj.message)},error:function(e,t,i){console.log("Bug"),console.log(e),alert("Erreur Ajax")}})})});